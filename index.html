<!DOCTYPE html>
<html lang="en-US" prefix="og: http://ogp.me/ns#">

    <head>
        <title></title>
        <style type="text/css">
            html, body {
                margin: 0;
                padding: 0;
                font-size: 13px;
                font-family: Helvetica, Arial, sans-serif;
                line-height: 1;
            }
            table {
                border-collapse: collapse;
                border-spacing: none;
            }
            p {
                margin: 0;
            }

            .CodeMirror {
                border: 1px solid #ccc;
            }
            #main-editor {
                width: 63%;
                display: inline-block;
                vertical-align: top;
            }
            #main-editor .CodeMirror {
            }
            #sidebar {
                width: 36%;
                display: inline-block;
                font-family: Courier;
                vertical-align: top;
                padding: 5px;
            }
            #sidebar tbody td {
                padding: 3px 0;
            }
            #sidebar tbody tr:nth-child(odd) td {
               background-color: #eee;
            }
            #sidebar thead th {
                text-align: left;
                padding: 3px 5px;
                background-color: #000;
                color: white;
            }
            #sidebar tr:last-child td {
                border-bottom: 10px solid white;
            }
            #sidebar tbody td {
                padding-left: 5px;
            }
            #sidebar tbody td:nth-child(2) {
                padding-left: 10px;
            }

            #sidebar .current-line-expansion {
                font-size: 14px;
                white-space: nowrap;
            }
            #sidebar .interpreted-line div {
                display: inline-block;
                vertical-align: top;
            }
            #sidebar .interpreted-line div[data] {
                margin: 1px 0;
                background-color: #ddd;
                text-align: center;
                border: 1px solid #aaa;
                border-width: 0 1px;
                overflow: hidden;
                white-space: nowrap;
                overflow: auto;
            }
            #sidebar .interpreted-line div[data].hover,
            #sidebar .current-line span.hover
            {
                background-color: #8ee5ff;
            }

        </style>
        <link href="node_modules/codemirror/lib/codemirror.css" rel="stylesheet">

        <!--
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@glenchsite" />
        <meta name="twitter:creator" content="@glench" />
        <meta property="og:type" content="article" />
        <meta property="og:url" content="http://glench.com/DeepListeningAtTheRecurseCenter/" />
        <meta property="og:title" content="Deep Listening at the Recurse Center" />
        <meta property="og:description" content="Helping programmers become more self-directed through meditative listening." />
        <meta property="og:image" content="http://glench.com/DeepListeningAtTheRecurseCenter/icon.png" />
        -->

    </head>
    <body>
        <div id="main-editor"></div>

        <div id="sidebar">
            <table>
                <thead> <tr> <th colspan="2">file</th> </tr> </thead>

                <tbody>
                    <tr><td>const $</td><td>require('jquery');</td></tr>

                    <tr><td>const _</td><td>require('underscore');</td></tr>
                    <tr><td>const React</td><td>require('react');</td></tr>
                    <tr><td>const ReactDOM</td><td>require('react-dom');</td></tr>
                    <tr><td>const CodeMirror</td><td>require('codemirror');</td></tr>
                    <tr><td>const rows</td><td>300;</td></tr>
                    <tr><td>const columns</td><td>30;</td></tr>
                    <tr><td>const cell_width</td><td>88; // including borders</td></tr>
                    <tr><td>const cell_height</td><td>19; // including borders</td></tr>
                    <tr><td>clamp(3,1,2)</td><td>2</td></tr>

                    <tr><td>const visualizations</td><td>require('./visualizations')</td></tr>
                    <tr><td>const interpreter</td><td>require('./interpreter')</td></tr>
                    <tr><td>const Block</td><td>interpreter.Block;</td></tr>
                    <tr><td>const Import</td><td>interpreter.Import;</td></tr>
                    <tr><td>var ui_blocks: UIBlock[]</td><td>[];</td></tr>

                    <tr> <td>class UIBlock {</td><td>something</td></tr>

                    <tr><td>class Move_Drag {</td><td>something</td></tr>

                    <tr><td>class Resize_Drag {</td><td>something</td></tr>

                    <tr><td>class Resize_Code_Drag {</td><td>something</td></tr>

                    <tr><td>var resize_drag: ?Resize_Drag</td><td>null;</td></tr>
                    <tr><td>var move_drag: ?Move_Drag</td><td>null;</td></tr>
                    <tr><td>var resize_code_drag: ?Resize_Code_Drag</td><td>null;</td></tr>



                </tbody>

                <thead>
                    <tr>
                        <th colspan="2">function initialize_grid() {</th>
                    </tr>
                </thead>

                <tbody>
                    <tr> <td>var $main</td> <td>$('canvas#main')</td> </tr>
                    <tr> <td>var height</td> <td>rows*cell_height;</td> </tr>
                    <tr> <td>var width</td> <td>columns*cell_width;</td> </tr>
                    <tr> <td>var canvas</td> <td>$main.get(0)</td> </tr>
                    <tr> <td>var ctx</td> <td>canvas.getContext('2d');</td> </tr>
                    <tr> <td>row</td> <td>299</td> </tr>
                    <tr> <td>column</td> <td>29</td> </tr>
                </tbody>
                <thead>
                    <tr>
                        <th colspan="2">$('body').on('mousemove', function(evt) {</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>evt</td><td>some thing</td></tr>
                    <tr><td>var ui_block</td><td>resize_drag.ui_block;</td></tr>
                    <tr><td>var dx</td><td>evt.pageX - resize_drag.x;</td></tr>
                    <tr><td>var dy</td><td>evt.pageY - resize_drag.y;</td></tr>
                    <tr><td>var new_columns</td><td>Math.floor(dx/cell_width);</td></tr>
                    <tr><td>var new_rows</td><td>Math.floor(dy/cell_height);</td></tr>
                    <tr><td>var previous_output_height</td><td>ui_block.output_height;</td></tr>
                </tbody>
            </table>

            <div id="current-line">
                <h2>Line 166</h2>
                <div class="current-line-expansion"></div>
                <div class="interpreted-line"></div>
            </div>

        </div>

        <script src="node_modules/jquery/dist/jquery.js"></script>
        <script src="node_modules/underscore/underscore.js"></script>
        <script src="node_modules/codemirror/lib/codemirror.js" charset="utf-8"></script>
        <script src="node_modules/codemirror/mode/javascript/javascript.js"></script>
        <script src="node_modules/flow-parser/flow_parser.js" charset="utf-8"></script>
        <script type="text/javascript">

            const $ = require('jquery');
            const fs = require('fs');


            function evalInContext(scr, context) {
                // execute script in private context
                return (new Function( "with(this) { return " + scr + "}")).call(context);
            }

            main_editor = CodeMirror(document.querySelector('#main-editor'), {
                value: fs.readFileSync('/Users/glen/code/flowsheets2/src/renderer.js', 'utf-8').toString(),
                mode: 'javascript',
                lineNumbers: true,
            });

            $('.CodeMirror').height($(window).height())
            main_editor.refresh()


            const current_line_number = 166;
            var current_line = main_editor.getLine(current_line_number-1);
            var current_line_ast = flow.parse(current_line);

            function ast_to_html(node) {
                switch (node.type) {
                    case 'IfStatement':
                        return '<span><span class="spacer">if (</span>'+ast_to_html(node.test)+') {</span>'
                    case 'BinaryExpression':
                        return '<span>' + ast_to_html(node.left) + ' <span> ' + node.operator + ' </span> ' + ast_to_html(node.right) + '</span>';
                    case 'Identifier':
                        return '<span>'+node.name+'</span>'
                    case 'Literal':
                        return `<span>${node.raw}</span>`;
                    case 'LabeledStatement':
                        return '<span>'+ node.label.name +': '+ ast_to_html(node.body) +'</span>'
                    case 'VariableDeclaration':
                        var type_str = '';
                        if (node.declarations[0].id.typeAnnotation) {
                            var range = node.declarations[0].id.typeAnnotation.typeAnnotation.range;
                            type_str = ': '+current_line.slice(range[0], range[1])
                        }
                        return `<span><span class="spacer">${node.kind} ${node.declarations[0].id.name}${type_str} = </span>${ast_to_html(node.declarations[0].init)}</span>`
                    case 'ExpressionStatement':
                        return '<span>'+ ast_to_html(node.expression) +'</span>'
                    case 'AssignmentExpression':
                        return '<span><span>'+ ast_to_html(node.left) +' '+ node.operator +'</span> '+ ast_to_html(node.right) +'</span>'
                    case 'MemberExpression':
                        return `<span><span>${node.object.name}</span>.${node.property.name}</span>`
                    case 'CallExpression':
                        return `<span><span>${node.callee.name}(</span>${node.arguments.map(arg_node => ast_to_html(arg_node)).join('<span>, </span>')})</span>`
                    default:
                        return 'DEFAULT UH OH'
                }
            }

            html_ast = ast_to_html(current_line_ast.body[0])

            $('#sidebar .current-line-expansion').append('<div class="current-line">'+html_ast+'</div>')

            var html_ast = document.querySelector('#sidebar .current-line > span');
            var scope = {
                columns: 30,
                new_columns: 2,
                resize_drag: {
                    original_width_in_columns: 1
                },
                clamp: function(num, min, max) {
                    if (num < min) {
                        return min;
                    } else if (num > max) {
                        return max
                    }
                    return num;
                },

                dx: 20,
                cell_width: 88,
            }

            function value_to_string(value) {
                if (_.isObject(value)) {
                    var str = '{'
                    _.each(value, (val, key) => {
                        str += `${key}: ${val},`
                    })
                    str +=' }'
                    return str
                }
                return value
            }

            function output_html(text, width) {
                try {
                    return '<div data="'+ text +'" style="width: '+ (width-2) +'px;">'+value_to_string(evalInContext(text, scope))+'</div>';
                } catch(e) {
                    return '<div data="'+ text +'" style="width: '+ (width-2) +'px;" class="spacer">...</div>'
                }

            }
            function interpret_html_ast(node) {
                if (node.children.length == 0) {
                    return output_html(node.innerText, $(node).width())
                }

                var output = '<div style="width: '+ ($(node).width()) +'px;">\n';

                output += output_html($(node).text(), $(node).width())

                output += '<div class="children" style="width: '+ ($(node).width()) +'px;">'
                for (var i = 0; i < node.children.length; ++i) {
                    var child = node.children[i];
                    output += interpret_html_ast(child)
                }
                output += '</div></div>\n'
                return output;
            }
            $('.interpreted-line').append(interpret_html_ast(html_ast))

            $('.interpreted-line div').filter(function(i, el ) {
                return el.innerText == '...'
            }).css('opacity', 0)

            $('.interpreted-line div[data]').on('mouseenter', function(evt) {
                var $target = $(evt.target);
                if ($target.css('opacity') !== '0') {
                    $target.addClass('hover')
                    var $subexpression = $('.current-line span').filter(function(i, el) {
                        return $(el).text() == $target.attr('data')
                    })
                    $subexpression.addClass('hover')
                }
            }).on('mouseleave', function(evt) {
                var $target = $(evt.target);
                $target.removeClass('hover')
                var $subexpression = $('.current-line span').filter(function(i, el) {
                    return $(el).text() == $target.attr('data')
                })
                $subexpression.removeClass('hover')

            })

            $('.current-line span').on('mouseenter', function(evt) {
                evt.stopPropagation();
                var $target = $(evt.target);
                $target.addClass('hover');
                $('.interpreted-line div[data="'+ $target.text() +'"]').addClass('hover')
            }).on('mouseleave', function(evt) {
                var $target = $(evt.target);
                $target.removeClass('hover');
                $('.interpreted-line div[data="'+ $target.text() +'"]').removeClass('hover')
            })


            /*

                Strategy for setting up example environment:
                    find all declarations (class, function, params, variable) before the cursor / inspection point and run them.
                    anything that isn't a computed value, make up a value? e.g. 'function(evt) {', want to account for evt object.

                    run file scope ->
                        run next scope ->
                            run next scope

                    things to consider:
                        if statement (can try to automatically make the condition true)
                        for loop
                        while loop
                        case statement
                        class declaration should call constructor
                        function
            */

            const flowRemoveTypes = require('flow-remove-types');
            const source = main_editor.getValue();
            const ast = flow.parse(source);
            var ast_before_current_line = ast.body.filter(node => node.loc.start.line < current_line_number);
            var file_scope_line_number_ends = ast_before_current_line[ast_before_current_line.length-2].loc.start.line;
            
            // TODO: actually build flowsheets fully using npm build command since other modules need to be imported
            // TODO: modify source to write to custom object instead of local scope (functions, classes, vars/const, module.exports )

            js_before_final_scope = `${flowRemoveTypes(source.split('\n').slice(0,file_scope_line_number_ends).join('\n')).toString()}

if (!_) {
    _ = require('/Users/glen/code/REPLugger/node_modules/underscore/underscore-min.js');
}
var replugger_initial_global = [ 'console', 'DTRACE_NET_SERVER_CONNECTION', 'DTRACE_NET_STREAM_END', 'DTRACE_HTTP_SERVER_REQUEST', 'DTRACE_HTTP_SERVER_RESPONSE', 'DTRACE_HTTP_CLIENT_REQUEST', 'DTRACE_HTTP_CLIENT_RESPONSE', 'global', 'process', 'Buffer', 'clearImmediate', 'clearInterval', 'clearTimeout', 'setImmediate', 'setInterval', 'setTimeout', '__filename', 'exports', 'module', '__dirname', 'require', '_', 'replugger_initial_global', 'replugger_new_keys' ]
var replugger_new_keys = _.difference(_.keys(global), replugger_initial_global);
process.stdout.write(JSON.stringify(_.keys(global))); 
process.stdout.write(JSON.stringify(replugger_new_keys)); 
process.stdout.write(JSON.stringify(_.pick(global, replugger_new_keys)));` 
console.log(js_before_final_scope)

            const { spawn } = require('child_process');
            var sub_process = spawn('node', ['--eval', js_before_final_scope], {cwd: '/Users/glen/code/flowsheets2/build/'})
            sub_process.stdout.on('data', function(data) {
                console.log('output!', data.toString())
            })
            sub_process.stderr.on('data', function(data) {
                console.log('error:', data.toString())
            })

        </script>
    </body>
</html>
