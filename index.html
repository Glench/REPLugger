<!DOCTYPE html>
<html lang="en-US" prefix="og: http://ogp.me/ns#">

    <head>
        <title></title>
        <style type="text/css">
            html, body {
                margin: 0;
                padding: 0;
                font-size: 13px;
                font-family: Helvetica, Arial, sans-serif;
                line-height: 1;
            }
            table {
                border-collapse: collapse;
                border-spacing: none;
            }
            p {
                margin: 0;
            }

            .CodeMirror {
                border: 1px solid #ccc;
            }
            #main-editor {
                width: 63%;
                display: inline-block;
                vertical-align: top;
            }
            #main-editor .CodeMirror {
            }
            #sidebar {
                width: 36%;
                display: inline-block;
                font-family: Courier;
                vertical-align: top;
                padding: 5px;
            }
            #sidebar tbody td {
                padding: 3px 0;
            }
            #sidebar tbody tr:nth-child(odd) td {
               background-color: #eee;
            }
            #sidebar thead th {
                text-align: left;
                padding: 3px 5px;
                background-color: #000;
                color: white;
            }
            #sidebar tr:last-child td {
                border-bottom: 10px solid white;
            }
            #sidebar tbody td {
                padding-left: 5px;
            }
            #sidebar tbody td:nth-child(2) {
                padding-left: 10px;
            }

            #sidebar .current-line-expansion {
                font-size: 14px;
                white-space: nowrap;
            }
            #sidebar .interpreted-line div {
                display: inline-block;
                vertical-align: top;
            }
            #sidebar .interpreted-line div[data] {
                margin: 1px 0;
                background-color: #ddd;
                text-align: center;
                border: 1px solid #aaa;
                border-width: 0 1px;
                overflow: hidden;
                white-space: nowrap;
                overflow: auto;
            }
            #sidebar .interpreted-line div[data].hover,
            #sidebar .current-line span.hover
            {
                background-color: #8ee5ff;
            }

        </style>
        <link href="node_modules/codemirror/lib/codemirror.css" rel="stylesheet">

        <!--
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@glenchsite" />
        <meta name="twitter:creator" content="@glench" />
        <meta property="og:type" content="article" />
        <meta property="og:url" content="http://glench.com/DeepListeningAtTheRecurseCenter/" />
        <meta property="og:title" content="Deep Listening at the Recurse Center" />
        <meta property="og:description" content="Helping programmers become more self-directed through meditative listening." />
        <meta property="og:image" content="http://glench.com/DeepListeningAtTheRecurseCenter/icon.png" />
        -->

    </head>
    <body>
        <div id="main-editor"></div>

        <div id="sidebar">
            <table>
                <thead> <tr> <th colspan="2">file</th> </tr> </thead>

                <tbody>
                    <tr><td>const $</td><td>require('jquery');</td></tr>

                    <tr><td>const _</td><td>require('underscore');</td></tr>
                    <tr><td>const React</td><td>require('react');</td></tr>
                    <tr><td>const ReactDOM</td><td>require('react-dom');</td></tr>
                    <tr><td>const CodeMirror</td><td>require('codemirror');</td></tr>
                    <tr><td>const rows</td><td>300;</td></tr>
                    <tr><td>const columns</td><td>30;</td></tr>
                    <tr><td>const cell_width</td><td>88; // including borders</td></tr>
                    <tr><td>const cell_height</td><td>19; // including borders</td></tr>
                    <tr><td>clamp(3,1,2)</td><td>2</td></tr>

                    <tr><td>const visualizations</td><td>require('./visualizations')</td></tr>
                    <tr><td>const interpreter</td><td>require('./interpreter')</td></tr>
                    <tr><td>const Block</td><td>interpreter.Block;</td></tr>
                    <tr><td>const Import</td><td>interpreter.Import;</td></tr>
                    <tr><td>var ui_blocks: UIBlock[]</td><td>[];</td></tr>

                    <tr> <td>class UIBlock {</td><td>something</td></tr>

                    <tr><td>class Move_Drag {</td><td>something</td></tr>

                    <tr><td>class Resize_Drag {</td><td>something</td></tr>

                    <tr><td>class Resize_Code_Drag {</td><td>something</td></tr>

                    <tr><td>var resize_drag: ?Resize_Drag</td><td>null;</td></tr>
                    <tr><td>var move_drag: ?Move_Drag</td><td>null;</td></tr>
                    <tr><td>var resize_code_drag: ?Resize_Code_Drag</td><td>null;</td></tr>



                </tbody>

                <thead>
                    <tr>
                        <th colspan="2">function initialize_grid() {</th>
                    </tr>
                </thead>

                <tbody>
                    <tr> <td>var $main</td> <td>$('canvas#main')</td> </tr>
                    <tr> <td>var height</td> <td>rows*cell_height;</td> </tr>
                    <tr> <td>var width</td> <td>columns*cell_width;</td> </tr>
                    <tr> <td>var canvas</td> <td>$main.get(0)</td> </tr>
                    <tr> <td>var ctx</td> <td>canvas.getContext('2d');</td> </tr>
                    <tr> <td>row</td> <td>299</td> </tr>
                    <tr> <td>column</td> <td>29</td> </tr>
                </tbody>
                <thead>
                    <tr>
                        <th colspan="2">$('body').on('mousemove', function(evt) {</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>evt</td><td>some thing</td></tr>
                    <tr><td>var ui_block</td><td>resize_drag.ui_block;</td></tr>
                    <tr><td>var dx</td><td>evt.pageX - resize_drag.x;</td></tr>
                    <tr><td>var dy</td><td>evt.pageY - resize_drag.y;</td></tr>
                    <tr><td>var new_columns</td><td>Math.floor(dx/cell_width);</td></tr>
                    <tr><td>var new_rows</td><td>Math.floor(dy/cell_height);</td></tr>
                    <tr><td>var previous_output_height</td><td>ui_block.output_height;</td></tr>
                </tbody>
            </table>

            <div id="current-line">
                <h2>Line 166</h2>
                <div class="current-line-expansion"></div>
                <div class="interpreted-line"></div>
            </div>

        </div>

        <script src="node_modules/jquery/dist/jquery.js"></script>
        <script src="node_modules/underscore/underscore.js"></script>
        <script src="node_modules/codemirror/lib/codemirror.js" charset="utf-8"></script>
        <script src="node_modules/codemirror/mode/javascript/javascript.js"></script>
        <script src="node_modules/flow-parser/flow_parser.js" charset="utf-8"></script>
        <script id="text" type="template">// @flow

const $ = require('jquery');
const _ = require('underscore');
const React = require('react');
const ReactDOM = require('react-dom');
const CodeMirror = require('codemirror');
require('codemirror/mode/python/python');
require('codemirror/mode/javascript/javascript');


const rows = 300;
const columns = 30;
const cell_width = 88; // including borders
const cell_height = 19; // including borders
module.exports.cell_height = cell_height;


// @Cleanup: probably move to utils at some point
function clamp(num: number, min: number, max: number):number {
    if (num < min) {
        return min
    } else if (num > max) {
        return max
    }
    return num;
}

const visualizations = require('./visualizations')
const interpreter = require('./interpreter')
const Block = interpreter.Block;
const Import = interpreter.Import;

var ui_blocks: UIBlock[] = [];
module.exports.ui_blocks = ui_blocks;

class UIBlock {
    row: number;
    column: number;

    should_auto_resize: boolean;
    width_in_columns: number;

    name_height: number; // in # of rows, not pixels
    code_height: number; // in # of rows, not pixels
    filter_clause_height: number; // in # of rows, not pixels
    sort_clause_height: number; // in # of rows, not pixels
    output_height: number; // in # of rows, not pixels
    visualization_options_height: number; // in # of rows

    block: Block;

    visualization: any; // should be React.Component, but @flow is awful
    visualization_options: any; // should be React.Component, but @flow is awful

    constructor() {
        this.should_auto_resize = true;
        this.width_in_columns = 1;

        this.name_height = 1;
        this.code_height = 1;
        this.filter_clause_height = 0;
        this.sort_clause_height = 0;
        this.output_height = 1;
        this.visualization = visualizations.DefaultViz;
        this.visualization_options_height = 0;
    }
};
module.exports.UIBlock = UIBlock;


class Move_Drag {
    start_x: number;
    start_y: number;

    ui_block: UIBlock;

    is_dragging(x:number, y:number):boolean {
        var dx = Math.abs(this.start_x - x);
        var dy = Math.abs(this.start_y - y);
        return Math.max(dx, dy) > 3;
    }
}

class Resize_Drag {
    x: number;
    y: number;
    ui_block: UIBlock;
    original_width_in_columns: number;
    original_output_height: number;
}

class Resize_Code_Drag {
    start_row: number;
    ui_block: UIBlock;
}

var resize_drag: ?Resize_Drag = null;
var move_drag: ?Move_Drag = null;
var resize_code_drag: ?Resize_Code_Drag = null;


function initialize() {
    initialize_grid();

    $('#new-import').on('click', function(evt) {
        create_and_render_import();
    })
}
module.exports.initialize = initialize;

function initialize_grid() {
    var $main = $('canvas#main')
    var height = rows*cell_height;
    var width = columns*cell_width;
    var canvas = $main.get(0)

    canvas.width = width;
    canvas.height = height;

    var ctx = canvas.getContext('2d');

    ctx.translate(0.5, 0.5);
    for (var row = 0; row < rows; ++row) {
        // draw rows horizontally
        ctx.beginPath();
        ctx.strokeStyle = '#ddd';
        ctx.lineWidth = 1;
        ctx.moveTo(0, row*cell_height);
        ctx.lineTo(width, row*cell_height);
        ctx.stroke();
        ctx.closePath();
    }

    for (var column = 0; column < columns; ++column) {
        ctx.beginPath();
        ctx.strokeStyle = '#ddd';
        ctx.lineWidth = 1;
        ctx.moveTo(column*cell_width, 0);
        ctx.lineTo(column*cell_width, height);
        ctx.stroke();
        ctx.closePath();
    }
    ctx.translate(-0.5, -0.5);


    $main.on('click', function(evt) {
        var column = Math.floor((evt.offsetX-2) / cell_width);
        var row = Math.floor((evt.offsetY-2) / cell_height);

        var block = interpreter.create_block(null, '1+1');
        create_and_render_block(block, row, column);
    });

    $('body').on('mouseup', reset_dragging);

    $('body').on('mousemove', function(evt) {
        if (resize_drag) {
            var ui_block = resize_drag.ui_block;
            ui_block.should_auto_resize = false;

            var dx = evt.pageX - resize_drag.x;
            var dy = evt.pageY - resize_drag.y;

            var new_columns = Math.floor(dx/cell_width);
            if (dx % cell_width > cell_width/3) {
                new_columns = Math.ceil(dx/cell_width);
            }
            ui_block.width_in_columns = clamp(resize_drag.original_width_in_columns + new_columns, 1, columns);

            var new_rows = Math.floor(dy/cell_height);
            if (dy % cell_height > cell_height/3) {
                new_rows = Math.ceil(dy/cell_height);
            }
            var previous_output_height = ui_block.output_height;
            ui_block.output_height = clamp(resize_drag.original_output_height + new_rows, 1, rows);

            if (ui_block.output_height > previous_output_height && !ui_block.block.error) {
                render_visualization(ui_block, ui_block.visualization)
            }
            resize(ui_block)
        } else if (move_drag) {
            if (move_drag.is_dragging(evt.pageX, evt.pageY)) {
                var offset = $('#main').offset();
                var x_wrt_grid = evt.pageX - offset.left + 1;
                var y_wrt_grid = evt.pageY - offset.top + 1;

                move_drag.ui_block.row = clamp(Math.floor(y_wrt_grid / cell_height), 0, rows);
                move_drag.ui_block.column = clamp(Math.floor(x_wrt_grid / cell_width), 0, columns);

                resize(move_drag.ui_block)
            }
        } else if (resize_code_drag) {
            var y_wrt_grid = (evt.pageY - $('#main').offset().top) + 1;
            var ui_block = resize_code_drag.ui_block;

            resize_code_drag.ui_block.code_height = clamp(Math.ceil((y_wrt_grid - (ui_block.row+ui_block.name_height)*cell_height)/ cell_height)-1, 1, rows); // @Cleanup should be rows-block height
            resize(resize_code_drag.ui_block)
        }
    });
}

function initialize_sidebar() {
    var $visualization_editor = $('<div class="visualization_editor">');

    var code = `class CustomViz extends React.Component {
  constructor(props) {
    super(props);
  }
  flash() {
    this.refs.container.style.backgroundColor = 'yellow';
    setTimeout(()=> this.refs.container.style.backgroundColor = 'transparent', 300);
  }
  componentDidUpdate(props) {
    this.flash();
  }
  componentDidMount() {
    this.flash();
  }
  render() {
    return React.createElement('div', {ref: 'container'}, this.props.block.output)
  }
}`

    var codemirror = CodeMirror($visualization_editor.get(0), {
        value: code,
        mode: 'javascript',
        tabSize: 2,
        scrollbarStyle: 'null', // just remove scrollbars for now for linux
        extraKeys: {
            'Ctrl-Enter': function(instance:CodeMirror) {
                var old_CustomViz = visualizations.CustomViz;
                try {

                    var CustomViz = eval(instance.getValue());
                    $visualization_editor.css({backgroundColor: 'white'})
                } catch(e) {
                    $visualization_editor.css({backgroundColor: '#ffa9a9'})
                    return;
                }
                visualizations.CustomViz = CustomViz;    
                ui_blocks.forEach(function(ui_block: UIBlock) {
                    if (ui_block.visualization && ui_block.visualization === old_CustomViz) {
                        ui_block.visualization = CustomViz;
                        render_output(ui_block.block);
                    }
                })
            }
        }
    });

    $visualization_editor.prepend('<h2>Edit Visualization</h2>')


    $('#sidebar').append($visualization_editor);
}

function create_and_render_import() {
    var import_ = interpreter.create_import('');

    var $input = $('<input>').attr('class', 'import');
    $input.on('change', function(evt) {
        interpreter.change_import_code(import_, evt.target.value)
    });
    $('#imports').append($input)
    $input.focus();
}

function reset_dragging(evt) {
    if (!resize_drag && !move_drag && !resize_code_drag) {
        return
    }
    evt.preventDefault();
    $('body').css('cursor', 'inherit');
    $('input').css('cursor', 'inherit')
    resize_drag = null;
    move_drag = null;
    resize_code_drag = null;
}

function create_and_render_block(block: Block, row: number, column: number) {
    var ui_block = new UIBlock();
    ui_block.row = row;
    ui_block.column = column;
    ui_block.block = block;
    ui_blocks.push(ui_block)

    var $block = $('<div>').attr('id', 'block-'+block.name).attr('class', 'block')
    $block.css({
        top: row*cell_height + 1,
        left: column*cell_width + 1,  
        height: 3*cell_height-1,
        width: cell_width-1,
    })

    // menu button
    var $menu_button = $('<div class="menu-button">').text('🔽').on('click', function(evt) {
        var $current_menu = $block.find('.menu, .submenu')
        if ($current_menu.length) {
            $current_menu.remove();
            return
        }

        var $menu = $('<ul class="menu">');

        var $delete = $('<li>').text('Delete (todo)').on('click', function(evt) {
            delete_(ui_block);
            interpreter.delete_(block);
        });
        $menu.append($delete);

        var $make_string = $('<li>').html(block.is_string_concat ? 'Make string&nbsp;✔' : 'Make string').on('click', function(evt) {
            var $make_string = $(evt.target);
            if (!block.is_string_concat) {
                block.is_string_concat = true;
                $block.find('.code .CodeMirror').addClass('is_string_concat')
            } else {
                block.is_string_concat = false;
                $make_string.text('Make string')
                $block.find('.code .CodeMirror').removeClass('is_string_concat')
            }
            $block.find('.menu, .submenu').remove();

        });
        $menu.append($make_string)

        var text = block.filter_clause ? 'Remove Filter' : 'Add Filter';
        var $filter = $('<li>').text(text).on('click', function(evt) {
            $block.find('.menu, .submenu').remove();
            if (block.filter_clause) {
                interpreter.remove_filter_clause(block);

                $block.find('.filter_clause').hide();
                ui_block.filter_clause_height = 0;
                resize(ui_block);

                return
            }
            var cm = $block.find('.filter_clause').show().find('.CodeMirror').get(0).CodeMirror;
            cm.refresh();
            cm.focus();
            block.filter_clause = 'True'
            ui_block.filter_clause_height = 1;

            resize(ui_block);
        });
        $menu.append($filter);

        var text = block.sort_clause ? 'Remove Sort' : 'Add Sort (todo)';
        var $sort = $('<li>').text(text).on('click', function(evt) {
            $block.find('.menu, .submenu').remove();
            if (block.sort_clause) {
                interpreter.remove_sort_clause(block);

                $block.find('.sort_clause').hide();
                ui_block.sort_clause_height = 0;
                resize(ui_block);

                return
            }
            var cm = $block.find('.sort_clause').show().find('.CodeMirror').get(0).CodeMirror;
            cm.refresh();
            cm.focus();
            block.sort_clause = block.name + '_';
            ui_block.sort_clause_height = 1;

            resize(ui_block);
        });
        $menu.append($sort);

        var $viz = $('<li>').html('Visualization&nbsp;&nbsp;▶').on('mouseenter', function(evt) {
            $block.find('.submenu').remove(); // remove old ones if they're still around

            var $submenu = $('<ul class="submenu">').css({
                left: $menu.width() + 7,
                top: 30,
            });
            $block.append($submenu);

            _.each(visualizations, function(react_component, name) {
                var text = name;
                var $li = $('<li>').html(name == ui_block.visualization.name ? '✔&nbsp;'+name : name).on('click', function(evt) {
                    $block.find('.menu, .submenu').remove();
                    ui_block.visualization = react_component;
                    render_output(block);
                });
                $submenu.append($li)
            })
        }).on('mouseleave', function(evt) {
            // $block.find('.submenu').remove();
        });
        $menu.append($viz);

        $block.prepend($menu)
    });
    $block.append($menu_button)

    // name
    var $name = $('<div class="name">')
    $name.append($('<input>').val(block.name).attr('readOnly', true).on('change', function(evt) {
          var old_name = block.name;
          var new_name = interpreter.change_name(block, evt.target.value);

          var $input = $(evt.target);
          $input.blur(); // this could trigger the 'change' event if it's after the .val() call
          $input.val(new_name); // rewrite in case the name changed because of sanitization
          $input.attr('readOnly', true)

          $input.parents('.block').attr('id', 'block-'+new_name)

    }).on('mousedown', function(evt) {
        evt.preventDefault();
        move_drag = new Move_Drag();
        move_drag.ui_block = ui_block;
        move_drag.start_x = evt.pageX;
        move_drag.start_y = evt.pageY;
        $('body').css('cursor', 'move');
        $(evt.target).css('cursor', 'move');
    }).on('dblclick', function(evt) {
        evt.stopPropagation();
        evt.preventDefault();
        move_drag = null;
        $(evt.target).css('cursor', 'inherit');

        // edit name
        var $target = $(evt.target);
        $target.removeAttr('readOnly')
        $target.focus();
        $target.select();
    }) );
    $block.append($name);


    function make_codemirror(element:HTMLElement, code:string, ui_block_cell_name: string, update_func: Function) {
        var codemirror = CodeMirror(element, {
            value: code,
            mode: 'python',
            autofocus: true,
            tabSize: 2,
            extraKeys: {
                'Enter': function(instance:CodeMirror) {
                    var code = instance.getValue()
                    if (!_.includes(code, '\n')) {
                        // if user presses enter when no newlines, run the code, otherwise put in newline
                        update_func(block, code)
                    } else {
                        if (ui_block.should_auto_resize) {
                            var _ui_block:Object = ui_block; // stupid @flow workaround: https://github.com/facebook/flow/issues/1730
                            _ui_block[ui_block_cell_name] = _.filter(code, x => x == '\n').length+2
                            resize(ui_block);
                        }
                        instance.replaceSelection('\n')
                    }
                },
                'Ctrl-Enter': function(instance:CodeMirror) {
                    var code = instance.getValue()
                    if (_.includes(code, '\n')) {
                        // if user presses ctrl-enter when there are newlines, run the code
                        update_func(block, code)
                    } else {
                        if (ui_block.should_auto_resize) {
                            var _ui_block:Object = ui_block; // stupid @flow workaround: https://github.com/facebook/flow/issues/1730
                            _ui_block[ui_block_cell_name] = _.filter(code, x => x == '\n').length+2
                            resize(ui_block);
                        }
                        instance.replaceSelection('\n')
                    }
                },
                'Tab': function(instance:CodeMirror) {
                    var current_place = instance.getCursor();
                    var current_line = instance.getLine(current_place.line);
                    if (current_place.ch == current_line.length && !current_line.match(/^\s*$/)) {
                        var new_block = interpreter.create_block(null, '1+1')
                        create_and_render_block(new_block, ui_block.row, ui_block.column + ui_block.width_in_columns)
                    } else {
                        instance.replaceSelection('  ') // @Robustness: should use codemirror tab options to do this
                    }
                },
            }
        });
        codemirror.setSelection({line: 0, ch: 0}, {line: Infinity, ch: Infinity}); // highlight all code
        codemirror.on('change', function(instance:CodeMirror) {
            // resize block automatically
            if (ui_block.should_auto_resize) {
                var code = instance.getValue();
                var _ui_block:Object = ui_block; // stupid @flow workaround: https://github.com/facebook/flow/issues/1730
                _ui_block[ui_block_cell_name] = clamp(_.filter(code, x => x == '\n').length+1, 1, 30); // limit pasting in long strings

                // make block width equal to the number of characters that will fit in a cell,
                var number_of_characters_that_will_fit_in_a_cell = 10.5;
                // make block's size fit the longest line in a code editor
                ui_block.width_in_columns = clamp(Math.ceil(_.last(_.sortBy(code.split('\n'), line => line.length)).length / number_of_characters_that_will_fit_in_a_cell), 1, 8);
                resize(ui_block);
            }

            // render references
            try {
                var marks = instance.getAllMarks();
                marks.forEach(mark => mark.clear()); // destroy and recreate all codemirror marks

                var positions = interpreter.get_user_identifiers_with_positions(instance.getValue());
                positions.forEach(position => {
                    var element = $('<span class="flowsheets-reference">').text(position.name).on('mouseenter', function(evt) {
                        var $reference_block = $('#block-'+position.name)
                        if (!$reference_block.length) {
                            $reference_block = $('#block-'+position.name.slice(0,position.name.length-1))
                        }
                        $reference_block.addClass('flowsheets-highlighted')
                    }).on('mouseleave', function(evt) {
                        var $reference_block = $('#block-'+position.name)
                        if (!$reference_block.length) {
                            $reference_block = $('#block-'+position.name.slice(0,position.name.length-1))
                        }
                        $reference_block.removeClass('flowsheets-highlighted')
                    }).get(0)

                    instance.markText(
                        {line: position.start_line, ch: position.start_ch},
                        {line: position.end_line, ch: position.end_ch},
                        {replacedWith: element}
                     )
                })
            } catch(e) {
                // almost certainly a python parse error in filbert from get_user_identifiers_with_positions
            }
        });
        codemirror.on('blur', function(instance:CodeMirror, evt) {
            instance.setSelection({line:0, ch:0})

            // don't let UI display of code get out of sync with output
            if (block.code !== instance.getValue()) {
                update_func(block, instance.getValue())
            }
        });
        codemirror.on('cursorActivity', function(instance:CodeMirror) {
            var selection = instance.getSelection();
            if (selection) {
                var $code = $(element);
                $code.find('.flowsheets-code-selection').remove();

                $code.append($('<div class="flowsheets-code-selection">➡️</div>').on('mousedown', function(evt) {
                    var new_block = interpreter.create_block(null, selection);
                    create_and_render_block(new_block, ui_block.row, ui_block.column+ui_block.width_in_columns);

                    instance.replaceSelection(new_block.name);
                    update_func(block, instance.getValue());
                }) )
            } else {
                $(element).find('.flowsheets-code-selection').remove();
            }
        })

        return codemirror;
    };

    // code
    var $code = $('<div class="code">')
    var code_mirror = make_codemirror($code.get(0), block.code, 'code_height', interpreter.change_code);
    $block.append($code)


    // code resizer
    var $code_resizer = $('<div class="code-resizer">');
    $code_resizer.on('mousedown', function(evt) {
        evt.preventDefault();

        $('body').css('cursor', 'ns-resize');
        ui_block.should_auto_resize = false;

        resize_code_drag = new Resize_Code_Drag();
        resize_code_drag.start_row = ui_block.row + ui_block.code_height;
        resize_code_drag.ui_block = ui_block;
    })
    $block.append($code_resizer)


    // filter clause
    var $filter_clause = $('<div class="filter_clause">').hide();
    var filter_codemirror = make_codemirror($filter_clause.get(0), 'True', 'filter_clause_height', interpreter.change_filter_clause);
    $block.append($filter_clause);

    // @TODO: need to add resizer UI for filter clause

    // sort clause
    var $sort_clause = $('<div class="sort_clause">').hide();
    var sort_codemirror = make_codemirror($sort_clause.get(0), block.name+'_', 'sort_clause_height', interpreter.change_sort_clause);
    $block.append($sort_clause);

    // output
    var $output = $('<div class="output">');
    $block.append($output)

    var $visualization_options = $('<div class="visualization_options">')
    $block.append($visualization_options)


    // resize handle
    var $resize = $('<div class="resize-handle">')
    $resize.on('mousedown', function(evt) {
        evt.preventDefault();

        resize_drag = new Resize_Drag();
        resize_drag.x = evt.pageX;
        resize_drag.y = evt.pageY;
        resize_drag.ui_block = ui_block;
        resize_drag.original_width_in_columns = ui_block.width_in_columns;
        resize_drag.original_output_height = ui_block.output_height;

        $('body').css('cursor', 'nwse-resize');
    }).on('mouseup', reset_dragging);
    $block.append($resize)

    $('#blocks').append($block);

    code_mirror.refresh(); // refresh in order to make text show up properly
};
module.exports.create_and_render_block = create_and_render_block;

function render_code(block: Block) {
    var $code_input = $('#block-'+block.name).find('.code .CodeMirror');
    $code_input.get(0).CodeMirror.setValue(block.code)
    fade_background_color($code_input, 1, 'rgba(220,220,220, ')
}
module.exports.render_code = render_code;

function render_filter_clause(block: Block, old_name: ?string) {
    var block_html_name = old_name ? old_name : block.name;
    var $filter_input = $('#block-'+block_html_name).find('.filter_clause .CodeMirror');
    $filter_input.get(0).CodeMirror.setValue(block.filter_clause)
    fade_background_color($filter_input, 1, 'rgba(220,220,220, ')
}
module.exports.render_filter_clause = render_filter_clause;

function render_error(block: Block) {
    var $output = $('#block-'+block.name).find('.output input')
    if (block.error) {
        $output.val(block.error)    
        $output.css('background-color', '#f00')
    } else {
        $output.css('background-color', 'inherit')
    }
}
module.exports.render_error = render_error;

function render_import_error(import_: Import) {
    var index = interpreter.imports.indexOf(import_);
    if (import_.error) {
        $('#imports input').eq(index).css({backgroundColor: 'red', color: 'white'})
    } else {
        $('#imports input').eq(index).css({backgroundColor: 'white', color: 'black'})
    }
}
module.exports.render_import_error = render_import_error;

function resize(ui_block: UIBlock) {
    var $block = $('#block-'+ui_block.block.name)

    $block.css({
        top: ui_block.row*cell_height + 1,
        left: ui_block.column*cell_width + 1,
        width: ui_block.width_in_columns*cell_width - 1,
        height: cell_height*(
            ui_block.name_height+
            ui_block.code_height+
            ui_block.filter_clause_height+
            ui_block.sort_clause_height+
            ui_block.output_height+
            ui_block.visualization_options_height
        ) - 1,
    })

    $block.find('.name input').width(cell_width*ui_block.width_in_columns - 7 /*padding*/);
    $block.find('.code').css('height', cell_height*ui_block.code_height - 1);
    $block.find('.filter_clause').css('height', cell_height*ui_block.filter_clause_height - 1);
    $block.find('.sort_clause').css('height', cell_height*ui_block.sort_clause_height - 1);
    $block.find('.output').css('height', cell_height*ui_block.output_height - 2);

    $block.find('.visualization_options').css('height', cell_height*ui_block.visualization_options_height - 1);
    if (ui_block.visualization_options_height == 0) {
        $block.find('.visualization_options').hide();
    } else {
        $block.find('.visualization_options').show();
    }
}

function render_output(block: Block) {
    var ui_block = ui_blocks.filter(ui_block => ui_block.block === block)[0];

    if (ui_block.should_auto_resize) {
        if (_.isArray(block.output) && _.isObject(block.output)) {
            ui_block.output_height = clamp(_.size(block.output), 1, 30)
        } else {
            ui_block.output_height = 1;
        }
    }

    var visualization:Object = ui_block.visualization;

    if (visualization.options) {
        ui_block.visualization_options_height = 1;
        ui_block.visualization_options = ReactDOM.render(
            React.createElement(visualization.options, {
                block: block,
                ui_block: ui_block,
                render_visualization: render_visualization,
            }),
            document.querySelector('#block-'+block.name+' .visualization_options')
        )
    } else {
        ui_block.visualization_options_height = 0;
        ui_block.visualization_options = null;
    }

    render_visualization(ui_block, visualization);


    resize(ui_block)
};
module.exports.render_output = render_output;
function render_visualization(ui_block: UIBlock, visualization: any) {
    try {
        ReactDOM.render(React.createElement(visualization, {
            block: ui_block.block,
            ui_block: ui_block,
            blocks: interpreter.blocks,
            options: ui_block.visualization_options ? ui_block.visualization_options.state : null,
            options_component: ui_block.visualization_options,
        }), document.querySelector('#block-'+ui_block.block.name+' .output'))

    } catch(e) {
        ui_block.block.error = 'Error in visualization: '+e;
        render_error(ui_block.block)
    }
}

function delete_(ui_block: UIBlock) {
    $('#block-'+ui_block.block.name).remove();
    ui_blocks = _.reject(ui_blocks, ui_block_to_reject => ui_block_to_reject === ui_block) 
}

function fade_background_color($element, alpha:number, color:string) {
    if (color[3] !== 'a') { throw 'Color needs to start with "rgba"'}
    alpha -= .04
    if (alpha < 0) {
        $element.css('background-color', 'transparent')
        return
    }
    var new_color = color.replace(' ', ` ${alpha})`)
    $element.css('background-color', new_color)
    setTimeout(fade_background_color, 1000/60, $element, alpha, color);
}


        </script>
        <script type="text/javascript">

            const $ = require('jquery');


            function evalInContext(scr, context) {
                // execute script in private context
                return (new Function( "with(this) { return " + scr + "}")).call(context);
            }

            main_editor = CodeMirror(document.querySelector('#main-editor'), {
                value: document.querySelector('#text').innerText,
                mode: 'javascript',
                lineNumbers: true,
            });

            $('.CodeMirror').height($(window).height())
            main_editor.refresh()


            const current_line_number = 166;
            var current_line = main_editor.getLine(current_line_number-1);
            var current_line_ast = flow.parse(current_line);

            function ast_to_html(node) {
                switch (node.type) {
                    case 'IfStatement':
                        return '<span><span class="spacer">if (</span>'+ast_to_html(node.test)+') {</span>'
                    case 'BinaryExpression':
                        return '<span>' + ast_to_html(node.left) + ' <span> ' + node.operator + ' </span> ' + ast_to_html(node.right) + '</span>';
                    case 'Identifier':
                        return '<span>'+node.name+'</span>'
                    case 'Literal':
                        return `<span>${node.raw}</span>`;
                    case 'LabeledStatement':
                        return '<span>'+ node.label.name +': '+ ast_to_html(node.body) +'</span>'
                    case 'VariableDeclaration':
                        var type_str = '';
                        if (node.declarations[0].id.typeAnnotation) {
                            var range = node.declarations[0].id.typeAnnotation.typeAnnotation.range;
                            type_str = ': '+current_line.slice(range[0], range[1])
                        }
                        return `<span><span class="spacer">${node.kind} ${node.declarations[0].id.name}${type_str} = </span>${ast_to_html(node.declarations[0].init)}</span>`
                    case 'ExpressionStatement':
                        return '<span>'+ ast_to_html(node.expression) +'</span>'
                    case 'AssignmentExpression':
                        return '<span><span>'+ ast_to_html(node.left) +' '+ node.operator +'</span> '+ ast_to_html(node.right) +'</span>'
                    case 'MemberExpression':
                        return `<span><span>${node.object.name}</span>.${node.property.name}</span>`
                    case 'CallExpression':
                        return `<span><span>${node.callee.name}(</span>${node.arguments.map(arg_node => ast_to_html(arg_node)).join('<span>, </span>')})</span>`
                    default:
                        return 'DEFAULT UH OH'
                }
            }

            html_ast = ast_to_html(current_line_ast.body[0])

            $('#sidebar .current-line-expansion').append('<div class="current-line">'+html_ast+'</div>')

            var html_ast = document.querySelector('#sidebar .current-line > span');
            var scope = {
                columns: 30,
                new_columns: 2,
                resize_drag: {
                    original_width_in_columns: 1
                },
                clamp: function(num, min, max) {
                    if (num < min) {
                        return min;
                    } else if (num > max) {
                        return max
                    }
                    return num;
                },

                dx: 20,
                cell_width: 88,
            }

            function value_to_string(value) {
                if (_.isObject(value)) {
                    var str = '{'
                    _.each(value, (val, key) => {
                        str += `${key}: ${val},`
                    })
                    str +=' }'
                    return str
                }
                return value
            }

            function output_html(text, width) {
                try {
                    return '<div data="'+ text +'" style="width: '+ (width-2) +'px;">'+value_to_string(evalInContext(text, scope))+'</div>';
                } catch(e) {
                    return '<div data="'+ text +'" style="width: '+ (width-2) +'px;" class="spacer">...</div>'
                }

            }
            function interpret_html_ast(node) {
                if (node.children.length == 0) {
                    return output_html(node.innerText, $(node).width())
                }

                var output = '<div style="width: '+ ($(node).width()) +'px;">\n';

                output += output_html($(node).text(), $(node).width())

                output += '<div class="children" style="width: '+ ($(node).width()) +'px;">'
                for (var i = 0; i < node.children.length; ++i) {
                    var child = node.children[i];
                    output += interpret_html_ast(child)
                }
                output += '</div></div>\n'
                return output;
            }
            $('.interpreted-line').append(interpret_html_ast(html_ast))

            $('.interpreted-line div').filter(function(i, el ) {
                return el.innerText == '...'
            }).css('opacity', 0)

            $('.interpreted-line div[data]').on('mouseenter', function(evt) {
                var $target = $(evt.target);
                if ($target.css('opacity') !== '0') {
                    $target.addClass('hover')
                    var $subexpression = $('.current-line span').filter(function(i, el) {
                        return $(el).text() == $target.attr('data')
                    })
                    $subexpression.addClass('hover')
                }
            }).on('mouseleave', function(evt) {
                var $target = $(evt.target);
                $target.removeClass('hover')
                var $subexpression = $('.current-line span').filter(function(i, el) {
                    return $(el).text() == $target.attr('data')
                })
                $subexpression.removeClass('hover')

            })

            $('.current-line span').on('mouseenter', function(evt) {
                evt.stopPropagation();
                var $target = $(evt.target);
                $target.addClass('hover');
                $('.interpreted-line div[data="'+ $target.text() +'"]').addClass('hover')
            }).on('mouseleave', function(evt) {
                var $target = $(evt.target);
                $target.removeClass('hover');
                $('.interpreted-line div[data="'+ $target.text() +'"]').removeClass('hover')
            })


            /*

                Strategy for setting up example environment:
                    find all declarations (class, function, params, variable) before the cursor / inspection point and run them
                    anything that isn't a computed value, make up a value? e.g. function(evt), want to account for evt object

                    things to consider:
                        if statement (some things not declared depending on its value)
                        for loop
                        while loop
                        case statement
                        class declaration should call constructor
            */

            const flowRemoveTypes = require('flow-remove-types');
            const source = main_editor.getValue();
            const ast = flow.parse(source);
            var ast_before_current_line = ast.body.filter(node => node.loc.start.line < current_line_number);
            var file_scope_line_number_ends = ast_before_current_line[ast_before_current_line.length-2].loc.start.line;
            // flowRemoveTypes(source.split('\n').slice(0,file_scope_line_number_ends).join('\n')).toString()
            js_before_final_scope = `var _ = require('/Users/glen/code/REPLugger/node_modules/underscore/underscore-min.js');
${'var butts = 0;'}
            
var replugger_initial_global = [ 'console', 'DTRACE_NET_SERVER_CONNECTION', 'DTRACE_NET_STREAM_END', 'DTRACE_HTTP_SERVER_REQUEST', 'DTRACE_HTTP_SERVER_RESPONSE', 'DTRACE_HTTP_CLIENT_REQUEST', 'DTRACE_HTTP_CLIENT_RESPONSE', 'global', 'process', 'Buffer', 'clearImmediate', 'clearInterval', 'clearTimeout', 'setImmediate', 'setInterval', 'setTimeout', '__filename', 'exports', 'module', '__dirname', 'require', '_', 'replugger_initial_global', 'replugger_new_keys' ]
var replugger_new_keys = _.difference(_.keys(global), replugger_initial_global);
process.stdout.write(JSON.stringify(replugger_new_keys));` 
console.log(js_before_final_scope)
            const { spawn } = require('child_process');
            var sub_process = spawn('node', ['--eval', js_before_final_scope])
            sub_process.stdout.on('data', function(data) {
                console.log('output!', data.toString())
            })
            sub_process.stderr.on('data', function(data) {
                console.log('error:', data.toString())
            })

            // run node on js_before_final_scope in correct directory
            // diff globals objects with _.difference(old_globals.keys(), globals.keys())
            // print out in json
        </script>
    </body>
</html>
