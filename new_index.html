<!DOCTYPE html>
<html lang="en-US" prefix="og: http://ogp.me/ns#">

    <head>
        <title></title>
        <style type="text/css">
            html, body {
                margin: 0;
                padding: 0;
                font-size: 13px;
                font-family: Helvetica, Arial, sans-serif;
                line-height: 1;
            }
            table {
                border-collapse: collapse;
                border-spacing: none;
            }
            p {
                margin: 0;
            }

            .CodeMirror {
                border: 1px solid #ccc;
            }
            .CodeMirror .CodeMirror-activeline-background {
                background-color: #ace0ff;
            }
            #main-editor {
                width: 60%;
                display: inline-block;
                vertical-align: top;
            }
            #main-editor .CodeMirror {
            }
            #sidebar {
                width: 36%;
                display: inline-block;
                font-family: Courier;
                vertical-align: top;
                padding: 5px;
            }
            #sidebar input {
                background-color: transparent;
                border: 0;
                width: 100%;
                font-family: Courier;
                font-size: 13px;
            }
            #sidebar h2 {
                background-color: #ace0ff;
                color: black;
                padding: 4px 10px;
            }
            #test {
                overflow: auto;
            }
            #sidebar #test {
                border: 1px solid #ddd;
            }
            #sidebar table {
                width: 100%;
                table-layout: auto;
            }
            #sidebar tbody td {
                padding: 3px 0;
            }
            #sidebar tbody tr:nth-child(even) td {
               background-color: #eee;
            }
            #sidebar thead th {
                text-align: left;
                padding: 3px 5px;
                background-color: #d2d2d2;
                color: black;
                border-bottom: 1px solid #9e9e9e;
            }
            #sidebar tbody td {
                padding-left: 5px;
            }
            #sidebar tbody td:nth-child(2) {
                padding-left: 10px;
                white-space: nowrap;
                width: 100%; /* makes sure this column takes up as much space as it can */
            }

            #sidebar #current-line {
                position: absolute;
                bottom: 0;
                background-color: white;
                width: 36%;
                padding-bottom: 20px;
            }
            #sidebar .current-line-expansion {
                font-size: 14px;
                white-space: nowrap;
            }
            #sidebar .interpreted-line div {
                display: inline-block;
                vertical-align: top;
            }
            #sidebar .interpreted-line div[data] {
                margin: 1px 0;
                background-color: #ddd;
                text-align: center;
                border: 1px solid #aaa;
                border-width: 0 1px;
                overflow: hidden;
                white-space: nowrap;
                overflow: auto;
            }
            #sidebar .interpreted-line div[data].hover,
            #sidebar .current-line span.hover
            {
                background-color: #8ee5ff;
            }

        </style>
        <link href="node_modules/codemirror/lib/codemirror.css" rel="stylesheet">
        <link href="node_modules/codemirror/addon/dialog/dialog.css" rel="stylesheet">

        <!--
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@glenchsite" />
        <meta name="twitter:creator" content="@glench" />
        <meta property="og:type" content="article" />
        <meta property="og:url" content="http://glench.com/DeepListeningAtTheRecurseCenter/" />
        <meta property="og:title" content="Deep Listening at the Recurse Center" />
        <meta property="og:description" content="Helping programmers become more self-directed through meditative listening." />
        <meta property="og:image" content="http://glench.com/DeepListeningAtTheRecurseCenter/icon.png" />
        -->

    </head>
    <body>
        <div id="main-editor"></div>

        <div id="sidebar">
        </div>

        <script src="node_modules/jquery/dist/jquery.js"></script>
        <script src="node_modules/underscore/underscore.js"></script>
        <script src="node_modules/codemirror/lib/codemirror.js"></script>
        <script src="node_modules/codemirror/mode/javascript/javascript.js"></script>
        <script src="node_modules/codemirror/addon/selection/active-line.js"></script>
        <script src="node_modules/codemirror/addon/edit/matchbrackets.js"></script>
        <script src="node_modules/codemirror/addon/search/searchcursor.js"></script>
        <script src="node_modules/codemirror/addon/dialog/dialog.js"></script>
        <script src="node_modules/codemirror/keymap/vim.js"></script>
        <script src="node_modules/flow-parser/flow_parser.js" charset="utf-8"></script>
        <script type="text/javascript">

            const $ = require('jquery');
            const fs = require('fs');
            const {scopes_and_names, prepare_current_file_to_act_as_server} = require('./mock_environment')
            const {dialog} = require('electron').remote;
            const exec = require('child_process').exec;
            const {spawn, spawnSync} = require('child_process')

            function assert(condition) {
                if (!condition) {
                    throw 'Assertion failed!'
                }
            }



            // --- set up editor ---

            var current_file_name = 'renderer.js';
            main_editor = CodeMirror(document.querySelector('#main-editor'), {
                value: fs.readFileSync('/Users/glen/code/REPLugger/staged_src/'+current_file_name, 'utf-8').toString(),
                mode: 'javascript',
                lineNumbers: true,
                styleActiveLine: true,
                indentUnit: 4,
                keyMap: 'vim',
                matchBrackets: true,
                showCursorWhenSelecting: true,
                inputStyle: 'contenteditable',
            });
            CodeMirror.Vim.map('jj', '<Esc>', 'insert')

            $('.CodeMirror').height($(window).height() - 2)
            main_editor.refresh() // for some reason only shows few lines

            main_editor.on('cursorActivity', _.debounce(cursor_activity, 200));
            function cursor_activity(codemirror_instance) {
                var line_number = codemirror_instance.getCursor().line+1;
                run(codemirror_instance.getValue(), line_number)
            }

            // NEXT STEPS:
            //    - evaluate current line
            //    - evaluate current line in pieces
            //    - generate straight-line code
            //    - better scope detection
            //       - add filled_in_names in scope detection
            //    - keep server online with functionality:
            //       - ask for more details about an object (like chrome inspector clicking arrow)
            //       - send straight-line code to run (will this work?)
            //       - overwrite specific values (and be able to save them on line they came from!)
            //        

            // TODO: get command+o working
            // https://github.com/electron/electron/blob/master/docs/api/dialog.md



            // --- build project and get mock server running ---


            // build initially, also as person types changes to file since they may create a new name as they type.
            // could be smart about seeing if there's a new name, but parsing names is time-consuming I believe 
            var mock_server = null;
            success_callback_queue = [];
            error_callback_queue = [];
            $(window).on('beforeunload', function() {
                console.log('killing!')
                mock_server.kill()
            });

            function build(current_file_src) {
                // 0. prepare special version of edited file, with server code / recorded values
                // 1. remove all files in staging area (except .babelrc), then copy other files to staging area, 'staged_src'
                // 2. run "compilation", `babel staged_src/ --out-dir mock_environment`
                // 3. report error if compilation failed, line number may be tricky
                console.log('building...')
                console.time('build');
                var scopes = scopes_and_names(current_file_src, current_file_src.split('\n').length-1);
                var mock_environment_server_src = prepare_current_file_to_act_as_server(current_file_src, scopes[0].names_in_scope)

                var build_command = exec('sh build_mock_environment.sh',
                    (error, stdout, stderr) => {
                        // console.log('stdout', stdout);
                        // console.log('stderr', stderr);
                        // if (error !== null) {
                        //     console.log(`exec error: ${error}`);
                        //     return
                        // }


                        // overwrite file the user is currently editing with a special one that runs a server we can query for data
                        fs.writeFile(`mock_environment/${current_file_name}`, mock_environment_server_src, function() {
                            if (mock_server) {
                                mock_server.kill('SIGKILL');
                            }

                            success_callback_queue.push(function(data) {
                                console.log('building done')
                                console.timeEnd('build')
                            })
                            error_callback_queue.push(function(data) {
                                console.error('error starting mock environment:', data)
                            })

                            mock_server = spawn('node', [current_file_name], {cwd: '/Users/glen/code/REPLugger/mock_environment/'});

                            mock_server.stdout.setEncoding('utf-8')
                            mock_server.stdout.on('data', function(buffer) {
                                var lines = buffer.toString().split('\n');
                                for (var i = 0; i < lines.length; ++i) {
                                    var data = lines[i];
                                    if (!data) {
                                        if (i != lines.length-1) { console.error('got an unexpected blank line in the middle of stdout', lines) }
                                        return
                                    }
                                    assert(success_callback_queue.length > 0 && error_callback_queue.length > 0)
                                    var success = success_callback_queue.shift();
                                    error_callback_queue.shift();
                                    success(data);
                                }
                            })

                            mock_server.stderr.on('data', function(buffer) { 
                                var raw = buffer.toString();
                                if (raw.startsWith('Warning')) {
                                    return
                                }
                                var lines = raw.split('\n');
                                for (var i = 0; i < lines.length; ++i) {
                                    var data = lines[i];
                                    if (!data) {
                                        if (i != lines.length-1) { console.error('got an unexpected blank line in the middle of stderr:', lines) }
                                        return
                                    }
                                    assert(success_callback_queue.length > 0 && error_callback_queue.length > 0)

                                    var error = error_callback_queue.shift();
                                    success_callback_queue.shift();
                                    error(data)
                                }
                            })
                            mock_server.on('exit', function() { 
                                console.log('mock environment process ended!')
                                mock_server = null;
                            })


                        });
                    });
            }
            build(main_editor.getValue());

            function run(current_file_src, line_number) {
                console.log('running...')
                if (!mock_server) {
                    console.error('no mock server detected! aborting')
                    return
                }

                // get scopes and names in scope for current line
                var scopes = scopes_and_names(current_file_src, line_number);
                scopes.forEach(function(scope) {
                    scope.names_in_scope.forEach(function(name) {
                        var success = function(data) {
                            console.log(name, '=', data)
                        }
                        var error = function(data) {
                            console.log('failed to get', name, ':', data)
                        }
                        get_summary(name, success, error)
                    });
                })

                // current line!
                var current_line_src = current_file_src.split('\n')[line_number-1];
                if (current_line_src.includes('=')) {
                    current_line_src = current_line_src.split('=')[1];
                }
                if (current_line_src.includes('return ')) {
                    current_line_src = current_line_src.split('return ')[1];
                }
                get_summary(current_line_src, function(data) { console.log('current line evaluates to:', data)}, function(data) { console.error('error when evaluating current line:', data)})
            }
            function noop() {}
            function get_summary(name, success, error) {
                success = success || function(data) {
                    console.log(name, '=', data)
                }
                error = error || function(data) {
                    console.log('failed to get', name, ':', data)
                }
                success_callback_queue.push(success);
                error_callback_queue.push(error);
                mock_server.stdin.write(`replugger_summary_info: ${name}\n`)
            }

            const Mousetrap = require('mousetrap');
            // Mousetrap.bind('command+g', () => { run(main_editor.getValue(), main_editor.getCursor().line+1)})
            Mousetrap.bind('command+b', () => { build(main_editor.getValue())} )

            const {Menu, MenuItem} = require('electron').remote;
            var menu = new Menu();
            menu.append(new MenuItem({
                label: 'Build',
                accelerator: 'CmdOrCtrl+S',
                click: () => { build(main_editor.getValue(), main_editor.getCursor().line+1) }
            }))

            function run_mock_environment_server() {
                // 1. run specially-prepared file in step build().0, e.g. `node renderer.js`
            }

            function on_typing() {
                // throttled probably

                // on new line (?) recompute names to look for
                // send 'straight-line' code to server that can be run sequentially, from top of file to the line the cursor is on
                // if error, report the error, line number can be tricky
                // ask for summary values of all names
            }




        </script>
    </body>
</html>